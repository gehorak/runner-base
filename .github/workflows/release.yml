# =============================================================================
# Release workflow
#
# PURPOSE
# -------
# Publish an immutable container image based on an explicitly validated
# Semantic Version tag.
#
# This workflow:
# - validates the release tag format (SemVer)
# - binds the image to an exact git commit
# - performs a minimal smoke test on the built image
# - publishes a fully identifiable, auditable artifact
#
# This file is part of the architectural contract.
# Any modification MUST be reviewed as a breaking change.
# =============================================================================


name: Release image


# -----------------------------------------------------------------------------
# Trigger configuration
#
# The workflow is triggered exclusively by annotated or lightweight git tags
# matching the pattern: vX.Y.Z
#
# Examples:
#   v0.1.0   → valid
#   v1.2.3   → valid
#   v1.0     → INVALID
#   v1.0.0-rc1 → INVALID
# -----------------------------------------------------------------------------

on:
  push:
    tags:
      - 'v*.*.*'


# -----------------------------------------------------------------------------
# Permissions
#
# Minimal required permissions only.
# -----------------------------------------------------------------------------

permissions:
  contents: read
  packages: write


# -----------------------------------------------------------------------------
# Jobs definition
# -----------------------------------------------------------------------------

jobs:

  # ===========================================================================
  # Release job
  #
  # Purpose:
  # - Build the container image for the tagged version
  # - Tag the image with the release version
  # - Publish the image to the container registry
  # ===========================================================================

  release:
    name: Build, validate and publish image
    runs-on: ubuntu-latest

    steps:

      # -----------------------------------------------------------------------
       # Checkout source
      #
      # The repository is checked out exactly at the tagged commit.
      # No branch state is involved.
      # -----------------------------------------------------------------------

      - name: Checkout source at tag
        uses: actions/checkout@v4
        with:
          fetch-depth: 0


      # -----------------------------------------------------------------------
      # Validate release tag (STRICT SemVer)
      #
      # Accepted format:
      #   vMAJOR.MINOR.PATCH
      #
      # This step fails hard on any deviation.
      # -----------------------------------------------------------------------

      - name: Validate release tag (SemVer)
        id: semver
        shell: bash
        run: |
          set -Eeuo pipefail

          TAG="${GITHUB_REF#refs/tags/}"

          if [[ ! "$TAG" =~ ^v([0-9]+)\.([0-9]+)\.([0-9]+)$ ]]; then
            echo "ERROR: Invalid release tag '$TAG'"
            echo "Expected format: vMAJOR.MINOR.PATCH (e.g. v1.2.3)"
            exit 1
          fi

          VERSION="${TAG#v}"
          COMMIT_SHA="$(git rev-parse HEAD)"

          echo "tag=$TAG"         >> "$GITHUB_OUTPUT"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "commit=$COMMIT_SHA" >> "$GITHUB_OUTPUT"

      # -----------------------------------------------------------------------
      # Define Docker image metadata
      #
      # OCI labels provide full artifact traceability:
      # - source repository
      # - exact commit hash
      # - build timestamp
      # -----------------------------------------------------------------------

      - name: Define Docker image metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: |
            ghcr.io/gehorak/runner-base
          tags: |
            type=raw,value=${{ steps.semver.outputs.version }}
            type=raw,value=${{ steps.semver.outputs.version | replace('.', '.') }}
            type=raw,value=latest
          labels: |
            org.opencontainers.image.title=runner-base
            org.opencontainers.image.description=Deterministic base runner image
            org.opencontainers.image.source=https://github.com/gehorak/runner-base
            org.opencontainers.image.version=${{ steps.semver.outputs.version }}
            org.opencontainers.image.revision=${{ steps.semver.outputs.commit }}
            org.opencontainers.image.created=${{ github.event.head_commit.timestamp }}



      # -----------------------------------------------------------------------
      # Authenticate to GitHub Container Registry
      #
      # Authentication is performed using the built-in GITHUB_TOKEN.
      # -----------------------------------------------------------------------

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}


      # -----------------------------------------------------------------------
      # Build image (local)
      #
      # The image is built locally first to allow validation before publishing.
      # -----------------------------------------------------------------------

      - name: Build image (local)
        uses: docker/build-push-action@v6
        with:
          context: .
          load: true
          tags: runner-release:test
          labels: ${{ steps.meta.outputs.labels }}

      # -----------------------------------------------------------------------
      # Minimal smoke test
      #
      # This step verifies that:
      # - the image can be started
      # - the runner entrypoint is functional
      #
      # This is NOT a full test suite.
      # CI is responsible for exhaustive validation.
      # -----------------------------------------------------------------------

      - name: Smoke test image
        shell: bash
        run: |
          set -Eeuo pipefail

          docker run --rm runner-release:test info > /dev/null

      # -----------------------------------------------------------------------
      # Publish image to GHCR
      #
      # Only executed after successful validation and smoke testing.
      # -----------------------------------------------------------------------

      - name: Publish image to GHCR
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}

# -----------------------------------------------------------------------------
# End of workflow
#
# CONTRACT GUARANTEES
# -------------------
# - Only valid SemVer tags can produce a release.
# - Every published image is traceable to a specific commit.
# - A runnable image is verified before publication.
# - No image is published implicitly from any branch.
# =============================================================================