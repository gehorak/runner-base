# =============================================================================
# Continuous Integration workflow
#
# This workflow defines the canonical CI pipeline for all runner-* repositories.
#
# Design goals:
# - Deterministic and reproducible builds
# - Fast failure on contract violations
# - Clear separation of build, test, and verification stages
# - Human-readable structure suitable for long-term maintenance
#
# This workflow is intentionally conservative and explicit.
# =============================================================================


name: CI


# -----------------------------------------------------------------------------
# Trigger configuration
#
# CI is executed on:
# - every push to the repository
# - every pull request targeting the default branch
#
# This ensures that:
# - all changes are validated before merge
# - the main branch always remains releasable
# -----------------------------------------------------------------------------

on:
  push:
    branches:
      - main
  pull_request:


# -----------------------------------------------------------------------------
# Permissions
#
# CI does not publish artifacts.
# Read-only permissions are sufficient.
# -----------------------------------------------------------------------------

permissions:
  contents: read

# -----------------------------------------------------------------------------
# Jobs definition
# -----------------------------------------------------------------------------

jobs:

  # ===========================================================================
  # Build job
  #
  # Purpose:
  # - Build the container image
  # - Verify that the Dockerfile is valid
  # - Produce an image artifact for subsequent test jobs
  # ===========================================================================

  build:
    name: Build runner image
    runs-on: ubuntu-latest

    steps:

      # -----------------------------------------------------------------------
      # Source checkout
      #
      # Fetch the repository content required for building the image.
      # -----------------------------------------------------------------------

      - name: Checkout source
        uses: actions/checkout@v4


      # -----------------------------------------------------------------------
      # Build image (local only)
      #
      # The image is NOT pushed anywhere.
      # It is built under a fixed local tag for test consistency.
      # -----------------------------------------------------------------------

      - name: Build runner image
        shell: bash
        run: |
          set -Eeuo pipefail

          docker build \
            --tag runner-ci:local \
            .


  # ===========================================================================
  # Test job
  #
  # Purpose:
  # - Execute all contract and regression tests
  # - Validate runner behavior and image identity
  # - Enforce architectural guardrails
  # ===========================================================================

  test:
    name: Run contract tests
    runs-on: ubuntu-latest
    needs: build

    steps:

      # -----------------------------------------------------------------------
      # Source checkout
      #
      # Tests require access to CI scripts stored in the repository.
      # -----------------------------------------------------------------------

      - name: Checkout source
        uses: actions/checkout@v4

      # -----------------------------------------------------------------------
      # Ensure test script executability (runtime adaptation)
      #
      # Rationale:
      # - CI must be able to execute test scripts in any environment
      #   (Linux, WSL, Windows checkouts).
      # - Repository file mode is treated as best-effort.
      # - This step guarantees runtime executability without mutating
      #   the committed source of truth.
      # -----------------------------------------------------------------------

      - name: Ensure CI test scripts are executable
        shell: bash
        run: |
          set -Eeuo pipefail

          for f in ci/*.sh; do
            [ -x "$f" ] || chmod 0755 "$f"
          done


      # -----------------------------------------------------------------------
      # Test execution
      #
      # All tests are executed explicitly and sequentially.
      # No test discovery or implicit ordering is used.
      #
      # The IMAGE variable is passed explicitly to avoid ambiguity.
      # -----------------------------------------------------------------------

      - name: Execute contract test suite
        shell: bash
        env:
          IMAGE: runner-ci:local
        run: |
          set -Eeuo pipefail

          ./ci/test-smoke.sh
          ./ci/test-image-identity.sh
          ./ci/test-runner-core.sh
          ./ci/test-negative.sh
          ./ci/test-runner-plugins.sh
          ./ci/test-domain.sh


# -----------------------------------------------------------------------------
# End of workflow
#
# CONTRACT GUARANTEES
# -------------------
# - CI always builds the image from the current repository state.
# - CI validates the full runner contract before any release is possible.
# - CI never publishes artifacts or images.
# - CI behavior is deterministic and environment-independent.
# =============================================================================
